name: Generate LoC Badge

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  generate:
    name: Generate Lines-of-Code Badge
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Make Code Badge
        uses: shadowmoose/GHA-LoC-Badge@1.0.0
        id: badge
        with:
          debug: true
          directory: ./
          badge: ./output/badge.svg
          patterns: "**/*.py|**/*.sh|Makefile"
          ignore: ".venv|venv|env|node_modules|.git"

      - name: Push badge to image-data branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          # Ensure git identity
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # Prepare a minimal repo containing only the badge and push it to image-data
          mkdir -p badge-tmp
          cp output/badge.svg badge-tmp/badge.svg
          cd badge-tmp
          git init
          git add badge.svg
          git commit -m "chore: update LoC badge"
          git remote add origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"
          git push --force origin HEAD:image-data
